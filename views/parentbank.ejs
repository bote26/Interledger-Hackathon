    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Parent Dashboard</title>
    <style>
        /* Serious, minimal parent styling */
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: #f4f6f8; color: #0f172a; margin: 0; }
        .container { max-width: 980px; margin: 32px auto; padding: 24px; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
        .brand { display:flex; gap:12px; align-items:center; }
        .brand h1 { margin:0; font-size:20px; color:#0b1220; }
        .btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(15,23,42,0.08); background:white; cursor:pointer; }
        .btn-primary { background: #0b5fff; color: white; border: none; }
        .card { background:white; border-radius:10px; padding:16px; box-shadow: 0 1px 2px rgba(2,6,23,0.06); margin-bottom:16px; }
        .row { display:flex; gap:16px; }
        .col { flex:1; }
        .small { font-size:0.9rem; color:#334155; }
        .balance { font-size:1.5rem; font-weight:700; }
        .muted { color:#64748b; font-size:0.9rem; }
        select, input[type=number], input[type=text] { width:100%; padding:10px; border-radius:8px; border:1px solid #e6eef8; }
        table { width:100%; border-collapse: collapse; }
        th, td { text-align:left; padding:8px 6px; border-bottom:1px solid #eef2f7; }
        th { color:#0b1220; font-weight:600; font-size:0.95rem; }
        .tx-amount-pos { color:#065f46; font-weight:600; }
        .tx-amount-neg { color:#7f1d1d; font-weight:600; }
        .task-list { list-style:none; padding:0; margin:0; }
        .task-item { padding:8px 0; border-bottom:1px dashed #eef2f7; display:flex; justify-content:space-between; align-items:center; }
        .task-title { font-weight:600; }
        .right { text-align:right; }
        /* Transfer modal */
        #transfer-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(2,6,23,0.4); z-index:4000; }
        .modal { width:460px; max-width:94%; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand">
                <div style="width:44px;height:44px;border-radius:8px;background:#0b1220;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;">P</div>
                <div>
                    <h1>Parent Dashboard</h1>
                    <div class="muted">Signed in as <strong><%= user.full_name %></strong></div>
                </div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn" onclick="syncAll()">Sync Now</button>
                <button class="btn btn-primary" onclick="openTransferModal()">New Transfer</button>
            </div>
        </div>

        <div class="row">
            <div class="col" style="flex:0.45;">
                <div class="card">
                    <div class="small">Your Balance</div>
                    <div class="balance" id="parent-balance">$<%= (wallet && wallet.balance) ? wallet.balance.toFixed(2) : '0.00' %></div>
                    <div class="muted" style="margin-top:8px;">Available to transfer to your children</div>
                </div>

                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div class="small">Children</div>
                        <div class="muted">Tasks</div>
                    </div>

                    <% if (children && children.length) { %>
                        <ul class="task-list" id="children-list">
                            <% children.forEach(function(child){ %>
                                <li class="task-item" style="cursor:pointer;" onclick="selectChild('<%= child.id %>')">
                                    <div>
                                        <div style="font-weight:700;"><%= child.full_name %></div>
                                        <div class="muted">View transactions & </div>
                                    </div>
                                    <div class="right muted">ID: <%= child.id %></div>
                                </li>
                            <% }) %>
                        </ul>
                    <% } else { %>
                        <div class="muted">No children registered.</div>
                    <% } %>
                </div>
            </div>

            <div class="col">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div>
                            <div class="small">Transactions</div>
                            <div class="muted">Choose which account to view</div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <select id="view-account" onchange="onViewAccountChange()">
                                <option value="self">My Account (Parent)</option>
                                <% if (children && children.length) { %>
                                    <% children.forEach(function(child){ %>
                                        <option value="child:<%= child.id %>"><%= child.full_name %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                    </div>

                    <div id="tx-list-container">
                        <table>
                            <thead>
                                <tr><th>Date</th><th>Description</th><th class="right">Amount</th></tr>
                            </thead>
                            <tbody id="tx-list-body">
                                <tr><td colspan="3" class="muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" id="child-tasks-card" style="margin-top:12px; display:none;">
                    <div class="small">Selected Child Tasks</div>
                    <ul class="task-list" id="child-task-list">
                        <!-- Filled by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transfer-modal">
        <div class="modal card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-weight:700;">New Transfer</div>
                <button class="btn" onclick="closeTransferModal()">✕</button>
            </div>

            <form id="transfer-form" onsubmit="handleTransfer(event)">
                <div style="margin-bottom:10px;">
                    <label class="small">From</label>
                    <select id="from_account" required>
                        <option value="<%= user.id %>">My Account — <%= user.full_name %></option>
                    </select>
                </div>

                <div style="margin-bottom:10px;">
                    <label class="small">To</label>
                    <select id="to_account" required>
                        <% if (children && children.length) { %>
                            <% children.forEach(function(child){ %>
                                <option value="<%= child.id %>"><%= child.full_name %></option>
                            <% }) %>
                        <% } %>
                        <option value="<%= user.id %>">My Account (self)</option>
                    </select>
                </div>

                <div style="margin-bottom:10px;">
                    <label class="small">Amount (USD)</label>
                    <input type="number" id="transfer-amount" step="0.01" min="0.01" required />
                </div>

                <div style="margin-bottom:12px;">
                    <label class="small">Description (optional)</label>
                    <input type="text" id="transfer-desc" />
                </div>

                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button type="button" class="btn" onclick="closeTransferModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Transfer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- children JSON payload for client JS (safe container) -->
    <script id="children-data" type="application/json"><%- JSON.stringify(children || []) %></script>
    <script>
        const parentId = '<%= user.id %>';
        let children = [];
        try {
            const dataEl = document.getElementById('children-data');
            if (dataEl) children = JSON.parse(dataEl.textContent || '[]');
        } catch (e) {
            console.debug('Failed to parse children JSON from DOM', e);
            children = [];
        }

        function syncAll() {
            fetch(`/dashboard/debug/sync/${parentId}`, { method:'POST', credentials:'same-origin' })
                .then(r=>r.json()).then(j=>{
                    if (j && j.ok) {
                        loadTransactionsForSelected();
                        alert('Sync complete');
                    } else {
                        alert('Sync finished — check logs for details');
                        loadTransactionsForSelected();
                    }
                }).catch(err=>{ console.error(err); alert('Sync failed: '+err.message); });
        }

        function openTransferModal(){ document.getElementById('transfer-modal').style.display = 'flex'; }
        function closeTransferModal(){ document.getElementById('transfer-modal').style.display = 'none'; document.getElementById('transfer-form').reset(); }

        async function handleTransfer(e){
            e.preventDefault();
            const from_user_id = document.getElementById('from_account').value;
            const to_user_id = document.getElementById('to_account').value;
            const amount = document.getElementById('transfer-amount').value;
            const description = document.getElementById('transfer-desc').value;

            const payload = { from_user_id, to_user_id, amount, description };
            try{
                const res = await fetch('/dashboard/transfer', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload), credentials:'same-origin'});
                const json = await res.json();
                if (res.ok) {
                    closeTransferModal();
                    loadTransactionsForSelected();
                    alert('Transfer successful');
                } else {
                    alert('Transfer failed: ' + (json.error || res.statusText));
                }
            } catch(err){ console.error(err); alert('Transfer error: '+err.message); }
        }

        function onViewAccountChange(){ loadTransactionsForSelected(); }

        function selectChild(childId){
            const sel = document.getElementById('view-account');
            sel.value = 'child:'+childId;
            showChildTasks(childId);
            loadTransactionsForSelected();
            // scroll to transactions
            window.scrollTo({ top: 200, behavior: 'smooth' });
        }

        function showChildTasks(childId){
            const card = document.getElementById('child-tasks-card');
            const list = document.getElementById('child-task-list');
            card.style.display = 'block';
            // Create tasks for this child (mock creation)
            const tasks = createTasksForChild(childId);
            list.innerHTML = tasks.map(t=>{
                if (t.status === 'completed') {
                    return `<li class="task-item" style="opacity:0.85;"><div><div class="task-title" style="text-decoration:line-through; color:#374151;">${t.title}</div><div class="muted">Reward ${t.reward}</div></div><div style="color:#065f46; font-weight:700;">Completed</div></li>`;
                }
                return `<li class="task-item"><div><div class="task-title">${t.title}</div><div class="muted">Reward ${t.reward}</div></div><div class="muted">Pending</div></li>`;
            }).join('');
        }

        // Simulate creating tasks for a child. Returns the created task list.
        function createTasksForChild(childId){
            // The user asked to create these specific tasks:
            const tasks = [
                { title: 'Clean my room', reward: '$5', status: 'completed' },
                { title: 'Help with dishes', reward: '$2', status: 'pending' },
                { title: 'Do Homework', reward: '$3', status: 'pending' }
            ];
            console.debug('Created tasks for child', childId, tasks);
            // Show a small ephemeral confirmation in the tasks card
            const card = document.getElementById('child-tasks-card');
            if (card) {
                const noteId = 'task-created-note';
                let note = document.getElementById(noteId);
                if (!note) {
                    note = document.createElement('div');
                    note.id = noteId;
                    note.style.marginTop = '8px';
                    note.style.fontSize = '0.9rem';
                    note.style.color = '#0b1220';
                    card.insertBefore(note, card.firstChild.nextSibling);
                }
                note.textContent = 'Tasks created for child — one completed, others pending.';
                setTimeout(()=>{ if (note) note.textContent = ''; }, 3000);
            }
            return tasks;
        }

        async function loadTransactionsForSelected(){
            const sel = document.getElementById('view-account');
            const value = sel.value;
            let uid = parentId;
            if (value && value.startsWith('child:')) uid = value.split(':')[1];

            const body = document.getElementById('tx-list-body');
            body.innerHTML = '<tr><td colspan="3" class="muted">Loading...</td></tr>';

            try{
                const [txRes, balRes] = await Promise.all([
                    fetch(`/dashboard/api/user/${uid}/transactions?limit=200`, {credentials:'same-origin'}).then(r=>r.json()),
                    fetch(`/dashboard/api/user/${uid}/balance`, {credentials:'same-origin'}).then(r=>r.json())
                ]);

                if (balRes && balRes.balance) {
                    // If viewing self, update parent balance shown at left only when self
                    if (uid === parentId) document.getElementById('parent-balance').textContent = '$' + (balRes.balance.balanceHuman || '0.00');
                }

                // Prefer provider's createdAt (raw.createdAt) when available, otherwise use updatedAt.
                const parseTxDate = (tx) => {
                    const raw = tx.raw || {};
                    const created = raw.createdAt || raw.created_at || raw.created || tx.updatedAt || null;
                    if (!created) return new Date(0);
                    try {
                        if (typeof created === 'string') return new Date(created);
                        if (created && typeof created.toDate === 'function') return created.toDate();
                        if (created && created._seconds) return new Date(created._seconds * 1000);
                        return new Date(created);
                    } catch (e) {
                        return new Date(0);
                    }
                };

                const items = (txRes.items || []).slice().sort((a, b) => parseTxDate(b) - parseTxDate(a));
                if (!items.length) {
                    body.innerHTML = '<tr><td colspan="3" class="muted">No transactions found</td></tr>';
                    return;
                }

                body.innerHTML = items.map(tx=>{
                    const date = tx.raw && (tx.raw.createdAt||tx.raw.created_at||tx.raw.created) ? (new Date(tx.raw.createdAt||tx.raw.created_at||tx.raw.created)).toLocaleDateString() : (new Date(tx.updatedAt||0).toLocaleDateString());
                    const desc = tx.description || tx.raw && tx.raw.description || (tx.direction === 'incoming' ? 'Received' : 'Sent');
                    const amount = tx.amountHuman ? tx.amountHuman : (tx.amountAtomic ? (Number(tx.amountAtomic)/(10**(tx.assetScale!=null?tx.assetScale:2))).toFixed(tx.assetScale!=null?tx.assetScale:2) : '0.00');
                    const cls = tx.direction==='incoming' ? 'tx-amount-pos' : 'tx-amount-neg';
                    const sign = tx.direction==='incoming' ? '+' : '-';
                    return `<tr><td style="width:140px;">${date}</td><td>${desc} <div class="muted" style="font-size:0.85rem;">Ref: ${tx.transactionId||tx.id||''}</div></td><td class="right"><span class="${cls}">${sign}$${amount}</span></td></tr>`;
                }).join('');

            } catch(err){ console.error(err); body.innerHTML = '<tr><td colspan="3" class="muted">Failed to load transactions</td></tr>'; }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function(){
            // Load transactions for the default selection
            loadTransactionsForSelected();
            // If there are children, show the first child's tasks as a convenience
            try {
                if (Array.isArray(children) && children.length > 0) {
                    console.debug('Parent view: showing tasks for first child', children[0].id);
                    showChildTasks(children[0].id);
                }
            } catch (e) { console.debug('Error showing child tasks by default', e); }
        });
    </script>
</body>
</html>
